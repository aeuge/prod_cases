### Q:
Использовал ли кто в проде продукт Postgres Pro Enterprise - Встроенная отказоустойчивость (BiHA)? Есть ли кейсы?
Рекомендовали бы?

### A: 
Полгода тестим в формате 2+1 (праймари, синхронная реплика, рефери+wal), планируем через пару месяцев выводить в прод.
По надежности и отказоустойчивости пока вопросов нет, много тестов провели.
Очень просто разворачивается, но многого не хватает, например, централизованного управления конфигами, API. Очень примитивное управление через psql.
Зато есть встроенный прокси и пулер proxima с 17 версии.
Еще нашел пару моментов, которые PostgresPro умолчали в доке - некоторые параметры в конфигах меняются через жуткие костыли, с, по факту, отключением отказоустойчивости в кластере.

### A2: 
Ближе к концу года будут(кейсы).
Учитывай, что BiHA только в Enterprise версии, в стандарте нет.

### A: 
Тестирую pgpro17? уже третья заявка в саппорт. В систем-ди юните забыли параметр. Ерунда, просто написал, что потеряли - поправьте.
При создании кластера с нуля требуется выполнить указания
https://postgrespro.ru/docs/enterprise/17/biha-setting-up-a-biha-cluster
```bash
При этом первая нода создается как
bihactl init \
     --biha-node-id=1 \
     --host=узел_1 \
     --port=порт_узла \
     --biha-port=порт_biha \
     --nquorum=количество_узлов \
     --pgdata=каталог_PGDATA_лидера
```
Для того, чтобы настроить кластер на работу с tls, надо следовать замечанию- 
https://postgrespro.ru/docs/enterprise/17/biha-setting-up-a-biha-cluster#BIHA-SETTING-UP-A-BIHA-CLUSTER-SSL-CONFIGURATION
     
Где сказано:
"С помощью утилиты OpenSSL сгенерируйте сертификат и закрытый ключ и сохраните их в каталоге /PGDATA/pg_biha на каждом узле кластера"
     
Однако, в таком случае, запуск команды bihactl init завершается ошибкой.
bihactl: PGDATA directory (/var/lib/pgpro/ent-17/data) is not empty, but --convert flag is not used.
Try "bihactl --help" for more information.

Каким же образом можно одновременно и разместить сертификаты в PGDATA и обеспечить отсутствие файлов внутри?


# Заметки по установке и настройке biha

## Дизайн утилиты bihactl.

Утилита bihactl не предусматривает указания в опциях командной строки параметров, указывающих на конфигурационные файлы или иные параметры, допустимые командной строкой сервера PostgreSQL. Все параметры, необходимые для работы утилиты, должны быть указаны в конфигурационном файле сервера PostgreSQL. Для этого утилита bihactl использует конфигурационные файлы по умолчанию, которые находятся в каталоге PGDATA.

Такое поведение обусловлено желанием использовать процесс физического копирования PGDATA для создания копии сервера на подключаемых нодах.

Это значит, что в процессе развертывания нет возможности задать набор клиентских сертификатов для защиты процедуры репликации в процессе копирования PGDATA, так как эти сертификаты должны быть размещены в PGDATA, который на момент копирования должен быть пустым.

## Процедура подключения дополнительных узлов.

Подключение дополнительных узлов к существующему серверу PostgreSQL производится путем копирования каталога PGDATA на дополнительный узел. Указанный процесс производится по незащищенным каналам связи, так как настройки доступа к ведущему узлу со стороны новых регламентируется следующим правилами из файла pg_hba.biha.conf

host postgres    biha_replication_user  all scram-sha-256
host biha_db     biha_replication_user  all scram-sha-256
host replication biha_replication_user  all scram-sha-256

Утилита bihactl для организации доступа с использует ключи, которые должны быть размещены на всех узлах в каталоге PGDATA/biha_db. Как следствие, первоначальное копирование PGDATA может происходит только без использования tls.

## Формат описания ведущего узла в процессе подключения нового.

После подключения нового узла к существующему серверу PostgreSQL формируется, так называемая, magic-string, которая содержит информацию о ведущем узле. Эта информация используется при подключении новых узлов к существующему серверу PostgreSQL. Однако внутри этой строки просто закодированы адрес и порты ведущего узла PostgreSQL в base64.

Таким образом аутентификация в процессе подклюбчения нового узла строится только на неизменности парольных фраз, которые используются для подключения к ведущему узлу. Что по сути исключает их ротацию в процессе подключения, а поскольку документация требует использовать еще и внешние файлы типа .pgpass, то и далее, поскольку трудно предположить, что ротация секретов может подразумевать привлечение консольных команд для этого.

## Следствия.

1. Дизайн использования bihactl заставляет использовать файлы конфигурации, размещенные строго по дефолтным путям и обязательно внутри PGDATA.
2. Копирование баз данных в процессе подключения происходит без защиты канала связи.
3. Возможность подключения без использование tls сохраняется и далее.
4. Использование файлов с секретами в пространстве рабочей учетки делает затруднительной ротацию секретов.

## Выводы.

Использование архитектуры biha не соответствует требованиям безопасности, которые предъявляются к критически важным системам: затруднительна ротация секретов, не исполняется требование к использованию только защищенной коммуникации.

## Возможные решения.

1. Реализовать указание конфигурационных файлов в командной строке утилиты bihactl.
2. Использовать в качестве секрета подключения к ведущему узлу, не парольную фразу, а специально создаваемый токен.


